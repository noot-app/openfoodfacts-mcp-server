#!/usr/bin/env bash

set -euo pipefail

source script/env "$@"

# Default values
NAME=""
BRAND=""
LIMIT=5
SERVER_URL="http://localhost:8080"
OPENFOODFACTS_MCP_TOKEN="your-secret-token"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --name) NAME="$2"; shift 2 ;;
        --brand) BRAND="$2"; shift 2 ;;
        --limit) LIMIT="$2"; shift 2 ;;
        --help) 
            echo "Usage: $0 --name <name> [--brand <brand>] [--limit <limit>]"
            echo ""
            echo "Example:"
            echo "  ./script/call --brand olipop --name \"cream soda\" --limit 1"
            exit 0 ;;
        *) echo "Error: Unknown option $1"; exit 1 ;;
    esac
done

[[ -z "$NAME" ]] && { echo "Error: --name is required"; exit 1; }

# Utility functions
call_mcp() {
    curl -s -X POST \
        -H "Authorization: Bearer $OPENFOODFACTS_MCP_TOKEN" \
        -H "Content-Type: application/json" \
        -H "Accept: application/json, text/event-stream" \
        "${@:2}" \
        -d "$1" \
        "$SERVER_URL/mcp"
}

extract_session_id() {
    grep -i "Mcp-Session-Id" "$1" | cut -d' ' -f2 | tr -d '\r\n'
}

extract_data() {
    grep "^data: " | sed 's/^data: //' | head -1
}

# Temporary files
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

echo -e "${BLUE} Searching for: $NAME${OFF}${BRAND:+ (Brand: $BRAND)}"

# 1. Initialize session
INIT_REQUEST='{"jsonrpc":"2.0","id":"1","method":"initialize","params":{"protocolVersion":"2025-06-18","capabilities":{},"clientInfo":{"name":"script-client","version":"1.0.0"}}}'
call_mcp "$INIT_REQUEST" -D "$TEMP_DIR/headers" > /dev/null
SESSION_ID=$(extract_session_id "$TEMP_DIR/headers")

# 2. Send initialized notification
INIT_NOTIFY='{"jsonrpc":"2.0","method":"notifications/initialized","params":{}}'
call_mcp "$INIT_NOTIFY" -H "Mcp-Session-Id: $SESSION_ID" > /dev/null

# 3. Make tool call
if [[ -n "$BRAND" ]]; then
    TOOL_REQUEST="{\"jsonrpc\":\"2.0\",\"id\":\"2\",\"method\":\"tools/call\",\"params\":{\"name\":\"search_products_by_brand_and_name\",\"arguments\":{\"name\":\"$NAME\",\"brand\":\"$BRAND\",\"limit\":$LIMIT}}}"
else
    TOOL_REQUEST="{\"jsonrpc\":\"2.0\",\"id\":\"2\",\"method\":\"tools/call\",\"params\":{\"name\":\"search_products_by_brand_and_name\",\"arguments\":{\"name\":\"$NAME\",\"limit\":$LIMIT}}}"
fi

RESPONSE=$(call_mcp "$TOOL_REQUEST" -H "Mcp-Session-Id: $SESSION_ID" | extract_data)
RESULT=$(echo "$RESPONSE" | jq -r '.result.content[0].text' 2>/dev/null)

# Output result
if command -v jq >/dev/null 2>&1; then
    echo "$RESULT" | jq '.'
else
    echo "$RESULT"
fi
